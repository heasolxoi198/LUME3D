<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RaveRoom3D — Bem-vindo</title>
  <style>
    html, body { height:100%; margin:0; font-family:Inter, Arial, sans-serif; background:#0a0a0a; color:#fff; overflow:hidden; }
    #canvas-container { width:100%; height:100%; }
    #ui { position:fixed; top:12px; left:12px; z-index:20; width:320px; background:rgba(0,0,0,0.5); padding:12px; border-radius:10px; display:none; }
    #peeps{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ background:rgba(255,255,255,0.06); padding:6px 8px; border-radius:999px; font-size:13px; }
    .player-controls{ display:flex; gap:8px; margin-top:8px; }
    .small{ padding:6px; font-size:13px; }

    /* Welcome screen */
    #welcome-screen { position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(10,10,10,0.95); display:flex; justify-content:center; align-items:center; z-index:50; }
    #welcome-box { background: rgba(0,0,0,0.7); padding:30px; border-radius:15px; text-align:center; min-width:280px; }
    #welcome-box h1{ margin-bottom:20px; font-size:24px; }
    #welcome-box input, #welcome-box select, #welcome-box button { margin:8px 0; width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color:#fff; }
    #welcome-box button{ cursor:pointer; background:#ff3b3b; border:none; font-weight:bold; transition:0.2s; }
    #welcome-box button:hover{ background:#ff6666; }
  </style>
</head>
<body>
  <!-- Welcome screen -->
  <div id="welcome-screen">
    <div id="welcome-box">
      <h1>Bem-vindo à RaveRoom3D!</h1>
      <input type="text" id="welcome-nick" placeholder="Digite seu nome" />
      <input type="color" id="welcome-color" value="#ff3b3b" />
      <select id="welcome-role">
        <option value="clubber">Clubber</option>
        <option value="dj">DJ</option>
      </select>
      <button id="enter-btn">Entrar na festa</button>
    </div>
  </div>

  <div id="ui">
    <strong>RaveRoom3D — Protótipo</strong>
    <label>Nome da sala (qualquer):<input id="room" value="minha-rave"/></label>
    <label>Você é host? (quem controla a reprodução):
      <select id="isHost"><option value="true">Sim (Host)</option><option value="false">Não (Convidado)</option></select>
    </label>
    <label>Fonte de áudio (DJ apenas, URL ou arquivo):<input id="audioUrl" placeholder="https://.../musica.mp3"/></label>
    <input id="file" type="file" accept="audio/*"/>
    <div class="player-controls">
      <button id="play" class="small">Play/Pause</button>
      <button id="seekBack" class="small">-5s</button>
      <button id="seekFwd" class="small">+5s</button>
    </div>
    <div id="peeps"></div>
  </div>

  <div id="canvas-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/renderers/CSS2DRenderer.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded',()=>{
    let userNick='', userColor='#ff3b3b', userRole='clubber';

    const welcomeScreen=document.getElementById('welcome-screen');
    const welcomeNick=document.getElementById('welcome-nick');
    const welcomeColor=document.getElementById('welcome-color');
    const welcomeRole=document.getElementById('welcome-role');
    const enterBtn=document.getElementById('enter-btn');
    const uiPanel=document.getElementById('ui');
    const roomInput=document.getElementById('room');
    const peepsDiv=document.getElementById('peeps');

    // --- Three.js setup ---
    const container=document.getElementById('canvas-container');
    const scene=new THREE.Scene();
    const camera=new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0,6,12);
    const renderer=new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x05050a);
    container.appendChild(renderer.domElement);

    const labelRenderer=new THREE.CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position='absolute';
    labelRenderer.domElement.style.top='0px';
    container.appendChild(labelRenderer.domElement);

    const controls=new THREE.OrbitControls(camera,labelRenderer.domElement);
    controls.enableDamping=true;

    // --- Cenário boate ---
    const floor=new THREE.Mesh(new THREE.BoxGeometry(20,0.1,20), new THREE.MeshStandardMaterial({color:0x111111,metalness:0.3,roughness:0.7})); scene.add(floor);
    const stage=new THREE.Mesh(new THREE.BoxGeometry(6,0.6,4), new THREE.MeshStandardMaterial({color:0x222222,metalness:0.5,roughness:0.4})); stage.position.set(0,0.3,-5); scene.add(stage);
    const speakerGeo=new THREE.BoxGeometry(0.5,1.2,0.5);
    const speakerMat=new THREE.MeshStandardMaterial({color:0x333333,metalness:0.5,roughness:0.3});
    const leftSpeaker=new THREE.Mesh(speakerGeo,speakerMat); leftSpeaker.position.set(-3,0.6,-4.5); scene.add(leftSpeaker);
    const rightSpeaker=new THREE.Mesh(speakerGeo,speakerMat); rightSpeaker.position.set(3,0.6,-4.5); scene.add(rightSpeaker);

    const ledColors=[0xff0040,0x00ff80,0x0040ff,0xffff00];
    const leds=[];
    for(let i=0;i<8;i++){
      const l=new THREE.PointLight(ledColors[i%ledColors.length],1,15);
      l.position.set(Math.sin(i/8*Math.PI*2)*6,2,Math.cos(i/8*Math.PI*2)*6);
      scene.add(l); leds.push(l);
    }

    const disco=new THREE.Mesh(new THREE.SphereGeometry(0.7,24,24), new THREE.MeshStandardMaterial({color:0xffffff,metalness:1,roughness:0.2}));
    disco.position.set(0,3.5,0); scene.add(disco);

    const avatars={};

    const audio=new Audio(); audio.crossOrigin='anonymous'; audio.loop=false; audio.preload='auto';
    let audioContext, sourceNode, analyser;
    function setupAudioNodes(){ if(audioContext) return; audioContext=new (window.AudioContext||window.webkitAudioContext)(); sourceNode=audioContext.createMediaElementSource(audio); analyser=audioContext.createAnalyser(); analyser.fftSize=256; sourceNode.connect(analyser); analyser.connect(audioContext.destination); }

    let channel;
    function joinChannel(){
      const roomName='raveroom|'+roomInput.value;
      if(channel) channel.close();
      channel=new BroadcastChannel(roomName);
      channel.onmessage=ev=>handleMessage(ev.data);
      send({type:'presence',nick:userNick,color:userColor});
    }
    function send(obj){ if(!channel) joinChannel(); obj.nick=userNick; channel.postMessage(obj); }
    function handleMessage(msg){ if(msg.type==='presence'){ addPeer(msg.nick,msg.color); } }
    function addPeer(name,color){ if(avatars[name]) return; const mat=new THREE.MeshStandardMaterial({color:new THREE.Color(color)}); const sphere=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,16),mat); sphere.position.set(Object.keys(avatars).length%8-4,0.6,-Math.floor(Object.keys(avatars).length/8)-1); scene.add(sphere); const div=document.createElement('div'); div.className='label'; div.textContent=name; div.style.padding='4px 8px'; div.style.background='rgba(0,0,0,0.5)'; const label=new THREE.CSS2DObject(div); label.position.set(0,0.8,0); sphere.add(label); avatars[name]={mesh:sphere,label:div}; refreshPeepsUI(); }
    function refreshPeepsUI(){ peepsDiv.innerHTML=''; for(const n of Object.keys(avatars)){ const el=document.createElement('span'); el.className='pill'; el.textContent=n; peepsDiv.appendChild(el); } }

    enterBtn.onclick=()=>{
      userNick=welcomeNick.value.trim()||'Convidado';
      userColor=welcomeColor.value;
      userRole=welcomeRole.value;
      welcomeScreen.style.display='none';
      uiPanel.style.display='block';
      addPeer(userNick,userColor);
      joinChannel();
      if(userRole==='dj'){ setupAudioNodes(); }
    };

    const freqData=new Uint8Array(128);
    function animate(t){ requestAnimationFrame(animate); disco.rotation.y+=0.01; controls.update(); renderer.render(scene,camera); labelRenderer.render(scene,camera); }
    animate();

    window.addEventListener('resize',()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); labelRenderer.setSize(window.innerWidth,window.innerHeight); });
  });
  </script>
</body>
</html>
